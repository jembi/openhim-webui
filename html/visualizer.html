<!DOCTYPE html>
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<html lang="en">
<head>
<meta charset="utf-8">
<title>HIM - Error Management Console</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="">

<!-- Le styles -->
<link href="../css/bootstrap.css" rel="stylesheet">
<script src="../js/jquery.min.js"></script>
<script src="../js/bootstrap.min.js"></script>
<style>
body {
	padding-top: 60px;
	/* 60px to make the container go all the way to the bottom of the topbar */
}
</style>

<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
<!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

<!-- Le fav and touch icons -->
<link rel="shortcut icon" href="ico/favicon.ico">
<link rel="apple-touch-icon-precomposed" sizes="114x114"
	href="ico/apple-touch-icon-114-precomposed.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72"
	href="ico/apple-touch-icon-72-precomposed.png">
<link rel="apple-touch-icon-precomposed"
	href="ico/apple-touch-icon-57-precomposed.png">

<!-- D3 -->
<script src="../js/d3.min.js"></script>
<script type="text/javascript">
var registries = [
	{ comp: "cr", desc: "Client Registry" },
	{ comp: "dhis", desc: "DHIS2" },
	{ comp: "sub", desc: "Subscription Database" }
];

var himRect, himText;

var visW = 900, visH = 400;
var pad = 20;

var himX = 0 + pad,
	himY = visH/2.0,
	himW = visW - 2.0*pad,
	himH = visH/4.0 - 2.0*pad;


function setupBasicComponent(compRect, compText, x, y, w, h, text) {
	compRect
		.attr("rx", 6)
		.attr("ry", 6)
		.attr("x", x)
		.attr("y", y)
		.attr("width", w)
		.attr("height", h)
		.style("fill", "#ccc");
	compText
		.attr("x", x + w/2.0)
		.attr("y", y + h/2.0)
		.attr("text-anchor", "middle")
		.text(text)
		.style("fill", "#000");
}

function setupRegistryComponent(compRect, compText, compConnector, index, text) {
	var compW = visW/registries.length - 2.0*pad,
		compH = visH/4.0 - 2.0*pad;
	var compX = index*compW + pad + index*pad*2.0,
		compY = 0 + pad;

	setupBasicComponent(compRect, compText, compX, compY, compW, compH, text);

	compConnector
		.attr("x1", compX + compW/2.0)
		.attr("y1", compY + compH)
		.attr("x2", compX + compW/2.0)
		.attr("y2", himY)
		.style("stroke-width", visW/150.0)
		.style("stroke", "#ddd");
}


var visualizerUpdate;

function play() {
	$("#play").hide();
	$("#pause").show();

	visualizerUpdate = setInterval( function() {
		$.getJSON("state").done(function(data) {
			himRect.transition().style("fill", "#555");
		});
	}, 1000);
}

function pause() {
	$("#play").show();
	$("#pause").hide();
	clearInterval(visualizerUpdate);
}

$(function() {
	var vis = d3.select("#visualizer")
		.append("svg:svg")
		.attr("width", visW)
		.attr("height", visH);

	himRect = vis.append("svg:rect");
	himText = vis.append("svg:text");
	setupBasicComponent(himRect, himText, himX, himY, himW, himH, "Health Information Mediator");

	for (var i=0; i<registries.length; i++) {
		registries[i].rect = vis.append("svg:rect");
		registries[i].text = vis.append("svg:text");
		registries[i].line = vis.append("svg:line");
		setupRegistryComponent(registries[i].rect, registries[i].text, registries[i].line, i, registries[i].desc);
	}

	play();
});
</script>
</head>

<body>

	<div class="navbar navbar-fixed-top">
		<div class="navbar-inner">
			<div class="container">
				<a class="btn btn-navbar" data-toggle="collapse"
					data-target=".nav-collapse"> <span class="icon-bar"></span> <span
					class="icon-bar"></span> <span class="icon-bar"></span>
				</a> <a class="brand" href="#">HIM - Error Management Console</a>
				<ul class="nav">
					<li><a href="../translist">Transaction Log</a></li>
					<li><a href="../monitor">Monitor</a></li>
					<li class="active"><a href="../visualizer">Visualizer</a></li>
					<li><a href="../reports">Reports</a></li>
					<li><a href="../about">About</a></li>
				</ul>
				<ul class="nav pull-right">
				  <li class="dropdown">
				    <a href="#"
				          class="dropdown-toggle"
				          data-toggle="dropdown">
				          <i class="icon-user icon-white"></i>
				          ${username}
				          <b class="caret"></b>
				    </a>
				    <ul class="dropdown-menu">
				      <li><a href="../auth/logout">Logout</a></li>
				    </ul>
				  </li>
				</ul>
			</div>
		</div>
	</div>

	<div class="container">
		<div id="controls" class="btn-toolbar">
			<div class="btn-group">
				<!--<a class="btn" href="#"><i class="icon-backward"></i></a>-->
				<a id="play" class="btn" href="#" onclick="play();"><i class="icon-play"></i></a>
				<a id="pause" class="btn" href="#" onclick="pause();"><i class="icon-pause"></i></a>
				<!--<a class="btn" href="#"><i class="icon-forward"></i></a>-->
			</div>
		</div>
		<div id="visualizer"/>
	</div>
	<!-- /container -->

</body>
</html>
